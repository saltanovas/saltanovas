<svg width="400" height="150" xmlns="http://www.w3.org/2000/svg">
  <foreignObject width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml" class="container">
      <style>
        :root { --content-max: 340px; } /* tune this cap */

        a { text-decoration: none; color: inherit; }

        .container{
          display:flex; flex-direction:row; align-items:center; justify-content:flex-start;
          padding:10px; gap:10px; height:100%; width:100%; box-sizing:border-box;
          border-radius:5px; background-color:#{{background_color}}; border:1px solid #{{border_color}};
          font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;
        }

        .art{ flex:0 0 auto; }
        .cover{ width:90px; height:90px; border-radius:5px; display:block; }

        /* center a width-capped stack so text and bars share the same width */
        .content{
          flex:1; display:flex; justify-content:center; align-items:center; overflow:hidden;
        }
        .stack{
          width:min(100%, var(--content-max));
          display:flex; flex-direction:column; align-items:center;
        }

        .song{
          font-size:20px; font-weight:700; text-align:center; margin-bottom:4px;
          white-space:nowrap; overflow:hidden; text-overflow:ellipsis;

          /* gradient text */
          background:linear-gradient(125deg,
            rgb({{ songPalette[0][0] }}, {{ songPalette[0][1] }}, {{ songPalette[0][2] }}),
            rgb({{ songPalette[1][0] }}, {{ songPalette[1][1] }}, {{ songPalette[1][2] }})
          );
          background-size:200% 100%; background-position:0% 50%;
          -webkit-text-fill-color:transparent; -webkit-background-clip:text;
          animation:gradient 15s ease infinite;
        }

        .artist{
          font-size:16px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
          background:linear-gradient(-125deg,
            rgb({{ songPalette[0][0] }}, {{ songPalette[0][1] }}, {{ songPalette[0][2] }}),
            rgb({{ songPalette[1][0] }}, {{ songPalette[1][1] }}, {{ songPalette[1][2] }})
          );
          background-size:200% 100%; background-position:0% 50%;
          -webkit-text-fill-color:transparent; -webkit-background-clip:text;
          animation:gradient 12s ease infinite;
        }

        /* bars share the same width as text via .stack */
        #bars{
          width:100%;
          display:flex; justify-content:center; align-items:flex-end;
          min-height:35px; gap:1px; /* set to 0 if you see crowding when tiny */
        }

        .bar{
          width:3px; height:15px;
          transform-origin:bottom center; /* keep baseline fixed */
          animation:gradient 15s ease infinite, pulse 0ms -800ms ease-in-out infinite alternate;

          background:linear-gradient(90deg,
            rgb({{ barPalette[0][0] }}, {{ barPalette[0][1] }}, {{ barPalette[0][2] }}) 0%,
            rgb({{ barPalette[1][0] }}, {{ barPalette[1][1] }}, {{ barPalette[1][2] }}) 33%,
            rgb({{ barPalette[2][0] }}, {{ barPalette[2][1] }}, {{ barPalette[2][2] }}) 66%,
            rgb({{ barPalette[3][0] }}, {{ barPalette[3][1] }}, {{ barPalette[3][2] }}) 100%
          );
          background-size:200% 100%;
          background-position:0% 50%;
        }

        @keyframes gradient{
          0%{ background-position:0% 50%; }
          50%{ background-position:100% 50%; }
          100%{ background-position:0% 50%; }
        }
        /* animate height via scale so the bottom stays aligned */
        @keyframes pulse{
          0%{ transform:scaleY(0.25); opacity:0.35; }
          100%{ transform:scaleY(1); opacity:0.95; }
        }

        /* keep your per-bar timing rules */
        {{barCSS|safe}}
      </style>

      <a class="art" href="{{songURI}}" target="_blank" rel="noopener noreferrer">
        <img src="data:image/png;base64, {{image}}" class="cover" alt="" />
      </a>

      <div class="content">
        <div class="stack">
          <a href="{{songURI}}" target="_blank" rel="noopener noreferrer">
            <div class="song">{{songName}}</div>
          </a>
          <a href="{{artistURI}}" target="_blank" rel="noopener noreferrer">
            <div class="artist">{{artistName}}</div>
          </a>
          <div id="bars">{{contentBar|safe}}</div>
        </div>
      </div>
    </div>
  </foreignObject>
</svg>
